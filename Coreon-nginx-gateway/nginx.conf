worker_processes auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile on;
  keepalive_timeout 65;

  # 게시판 파일 업로드 대비
  client_max_body_size 50m;

  # 공통 프록시 헤더
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # (중요) ECS 내부 DNS/Service Connect 이름해결이 불안정하면 resolver를 켜야 함
  # VPC DNS resolver는 보통 VPC CIDR의 .2 (예: 10.10.0.2)
  resolver 10.10.0.2 valid=10s ipv6=off;

  server {
    listen 80;

    # ALB 헬스체크 용
    location = /health {
      return 200 "OK";
      add_header Content-Type text/plain;
    }

    # ---------------------------
    # API 라우팅
    # ---------------------------

    location /api/auth/ {
      rewrite ^/api/auth/(.*)$ /$1 break;
      proxy_pass http://auth.coreon.local:8081;
    }

    location /api/member/ {
      rewrite ^/api/member/(.*)$ /$1 break;
      proxy_pass http://member.coreon.local:8082;
    }

    location /api/faq/ {
      rewrite ^/api/faq/(.*)$ /$1 break;
      proxy_pass http://faq.coreon.local:8083;
    }

    location /api/board/ {
      rewrite ^/api/board/(.*)$ /$1 break;
      proxy_pass http://board.coreon.local:8084;
    }

    location /api/notice/ {
      rewrite ^/api/notice/(.*)$ /$1 break;
      proxy_pass http://notice.coreon.local:8085;
    }

    # ---------------------------
    # Front 라우팅
    # ---------------------------
    location / {
      proxy_pass http://front:80;
    }
  }
}
